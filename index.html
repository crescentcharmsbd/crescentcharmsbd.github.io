<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crescent Charms BD - Business Manager</title>
    <link rel="icon" type="image/png" href="Crescent_Charms.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #e94560 0%, #0f3460 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #f5f5f5;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .nav-btn.active {
            background: #e94560;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
        }
        
        .nav-btn:not(.active) {
            background: white;
            color: #e94560;
            border: 2px solid #e94560;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .section {
            display: none;
            padding: 30px;
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #e94560;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #e94560;
            color: white;
        }
        
        .btn-primary:hover {
            background: #d63651;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-info {
            background: #0f3460;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: #0f3460;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-delivered {
            background: #d4edda;
            color: #155724;
        }
        
        .status-canceled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            background: #f0f0f0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
        }
        
        .action-btn {
            padding: 6px 12px;
            font-size: 14px;
            margin-right: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .modal-close:hover {
            color: #000;
        }
        
        .invoice {
            background: white;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .invoice-header {
            border-bottom: 3px solid #e94560;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .product-list-item {
            background: #f5f5f5;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-badge {
            background: #e94560;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .profit-positive {
            color: #155724;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #721c24;
            font-weight: bold;
        }
        
        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .invoice {
                box-shadow: none;
            }
        }
        .category-row td {
    border-top: 2px solid #ddd;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåô Crescent Charms BD</h1>
            <p>Business Management System</p>
        </div>
        
        <div class="nav-buttons no-print">
            <button class="nav-btn" onclick="showSection('inventory')">üì¶ Inventory</button>
            <button class="nav-btn" onclick="showSection('orders')">üìã Orders</button>
            <button class="nav-btn" onclick="showSection('customers')">üë• Customers</button>
            <button class="nav-btn" onclick="showSection('invoices')">üßæ Invoices</button>
        </div>
        
        <!-- Inventory Section -->
        <div id="inventory" class="section">
            <h2>Inventory Management</h2>
            <div class="form-row" style="margin-top: 30px;">
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="itemName" placeholder="Enter item name">
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <select id="itemCategory">
                        <option value="">Select category</option>
                        <option value="Bracelets">Bracelets</option>
                        <option value="Necklaces">Necklaces</option>
                        <option value="Earrings">Earrings</option>
                        <option value="Rings">Rings</option>
                        <option value="Anklets">Anklets</option>
                        <option value="Charms">Charms</option>
                        <option value="Sets">Sets</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Cost Price (BDT) *</label>
                    <input type="number" id="itemCost" placeholder="What you paid">
                </div>
                <div class="form-group">
                    <label>Selling Price (BDT) *</label>
                    <input type="number" id="itemPrice" placeholder="What you sell for">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Product Link</label>
                    <input type="url" id="itemLink" placeholder="https://example.com/product">
                </div>
                <div class="form-group">
                    <label>Photo URL (Direct image link)</label>
                    <input type="url" id="itemPhoto" placeholder="https://i.imgur.com/image.jpg">
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveItem()">‚ûï Add Item</button>
            <button class="btn" onclick="cancelEditItem()" id="cancelItemBtn" style="display: none; background: #999; color: white;">‚úñ Cancel</button>
            
            <div style="margin-top: 40px;">
                <input type="text" id="searchInventory" placeholder="üîç Search inventory..." onkeyup="renderInventory()" style="width: 100%;">
            </div>
            <select id="categoryFilter" onchange="renderInventory()" class="form-control">
    <option value="">All Categories</option>
</select>

            
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Category</th>
                        <th>Name</th>
                        <th>Cost</th>
                        <th>Selling Price</th>
                        <th>Margin</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>
        
        <!-- Orders Section -->
        <div id="orders" class="section">
            <h2>Order Management</h2>
            <div class="form-row" style="margin-top: 30px;">
                <div class="form-group">
                    <label>Customer *</label>
                    <select id="orderCustomer" onchange="loadCustomerData()">
                        <option value="">Select or add new customer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="orderName" placeholder="Enter customer name">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" id="orderPhone" placeholder="+880 1XXX-XXXXXX">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="orderEmail" placeholder="customer@example.com">
                </div>
            </div>
            <div class="form-group">
                <label>Address *</label>
                <textarea id="orderAddress" rows="2" placeholder="Delivery address"></textarea>
            </div>
            <div class="form-group">
                <label>Customer Notes</label>
                <textarea id="orderNotes" rows="2" placeholder="Special requests, preferences, etc."></textarea>
            </div>
            
            <h3 style="margin-top: 30px;">Products</h3>
            <div id="orderProductsList"></div>
            <div class="form-row">
                <div class="form-group">
                    <label>Select Product</label>
                    <select id="orderProduct"></select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="orderQuantity" value="1" min="1">
                </div>
            </div>
            <button class="btn btn-info" onclick="addProductToOrder()">‚ûï Add Product</button>
            
            <div class="form-row" style="margin-top: 20px;">
                <div class="form-group">
                    <label>Total Cost (Auto)</label>
                    <input type="number" id="orderCost" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Gross Amount *</label>
                    <input type="number" id="orderGross" placeholder="What customer paid" oninput="calcOrderProfit()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Profit (Auto)</label>
                    <input type="number" id="orderProfit" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="orderStatus">
                        <option value="pending">Pending</option>
                        <option value="delivered">Delivered</option>
                        <option value="canceled">Canceled</option>
                    </select>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveOrder()">‚úÖ Create Order</button>
            <button class="btn" onclick="cancelEditOrder()" id="cancelOrderBtn" style="display: none; background: #999; color: white;">‚úñ Cancel</button>
            
            <div style="margin-top: 40px;">
                <input type="text" id="searchOrders" placeholder="üîç Search orders..." onkeyup="renderOrders()" style="width: 100%;">
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Tracking</th>
                        <th>Customer</th>
                        <th>Products</th>
                        <th>Gross</th>
                        <th>Profit</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersBody"></tbody>
            </table>
        </div>
        
        <!-- Customers Section -->
        <div id="customers" class="section">
            <h2>Customer Database</h2>
            <div style="margin-top: 20px;">
                <input type="text" id="searchCustomers" placeholder="üîç Search customers..." onkeyup="renderCustomers()" style="width: 100%;">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Total Orders</th>
                        <th>Total Spent</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customersBody"></tbody>
            </table>
        </div>
        
        <!-- Invoices Section -->
        <div id="invoices" class="section">
            <h2>Generate Invoice</h2>
            <div class="form-group" style="margin-top: 20px;">
                <label>Enter Tracking Number</label>
                <input type="text" id="invoiceTracking" placeholder="CC-XXXXX">
            </div>
            <button class="btn btn-primary" onclick="generateInvoice()">üìÑ Generate Invoice</button>
            
            <div id="invoicePreview" style="margin-top: 30px;"></div>
        </div>
    </div>
    
    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="modal-close no-print" onclick="closeInvoice()">&times;</span>
            <div id="invoiceContent"></div>
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Invoice</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const SHEET_ID = '1jU07VA_IKBi50rg_mHahr0rUxfUYpure8JCYY9jBYx0';
        const API_KEY = 'AIzaSyDsB7LyUHBbsF--oTUI_b6KeGM2xGCVIAc';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby7YHt9WnuTgtGlNBHob36Q9ud-SZE2tVQi9at2M3mAznEDjXYoRwknmJ2JmRsORjcj/exec';
        const PASSWORD = 'Crescent@@4545T';
        
        let inventory = [];
        let orders = [];
        let customers = [];
        let currentOrderProducts = [];
        let isUnlocked = false;
        let editingItemId = null;
        let editingOrderId = null;
        
        // Show section
        function showSection(section) {
            if (!isUnlocked) {
                const pwd = prompt('üîí Enter password:');
                if (pwd !== PASSWORD) {
                    alert('‚ùå Incorrect password!');
                    return;
                }
                isUnlocked = true;
            }
            
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
if (section === 'inventory') {
    populateCategoryFilter();
    renderInventory();
}
            if (section === 'orders') {
                renderOrders();
                updateCustomerDropdown();
                updateProductDropdown();
            }
            if (section === 'customers') renderCustomers();
        }
        
        // INVENTORY FUNCTIONS
        function saveItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const cost = parseFloat(document.getElementById('itemCost').value);
            const price = parseFloat(document.getElementById('itemPrice').value);
            const link = document.getElementById('itemLink').value.trim();
            const photo = document.getElementById('itemPhoto').value.trim();
            
            if (!name || !category || !cost || !price) {
                alert('Please fill required fields!');
                return;
            }
            
            if (editingItemId) {
                // Update existing
                const item = inventory.find(i => i.id === editingItemId);
                if (item) {
                    item.name = name;
                    item.category = category;
                    item.cost = cost;
                    item.price = price;
                    item.link = link;
                    item.photo = photo;
                }
                editingItemId = null;
                document.querySelector('#inventory .btn-primary').textContent = '‚ûï Add Item';
                document.getElementById('cancelItemBtn').style.display = 'none';
            } else {
                // Add new
                inventory.push({
                    id: Date.now(),
                    name,
                    category,
                    cost,
                    price,
                    link,
                    photo
                });
            }
            populateCategoryFilter();
            renderInventory();
            saveToGoogleSheets();
            
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemLink').value = '';
            document.getElementById('itemPhoto').value = '';
        }
        
        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            editingItemId = id;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemCost').value = item.cost;
            document.getElementById('itemPrice').value = item.price;
            document.getElementById('itemLink').value = item.link || '';
            document.getElementById('itemPhoto').value = item.photo || '';
            
            document.querySelector('#inventory .btn-primary').textContent = 'üíæ Update Item';
            document.getElementById('cancelItemBtn').style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function cancelEditItem() {
            editingItemId = null;
            document.getElementById('itemName').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemCost').value = '';
            document.getElementById('itemPrice').value = '';
            document.getElementById('itemLink').value = '';
            document.getElementById('itemPhoto').value = '';
            document.querySelector('#inventory .btn-primary').textContent = '‚ûï Add Item';
            document.getElementById('cancelItemBtn').style.display = 'none';
        }
        
function renderInventory() {
const search = document.getElementById('searchInventory')?.value.toLowerCase() || '';
const selectedCategory = document.getElementById('categoryFilter')?.value || '';

let filtered = inventory.filter(i => {
    const matchSearch =
        i.name.toLowerCase().includes(search) ||
        i.category.toLowerCase().includes(search);

    const matchCategory = !selectedCategory || i.category === selectedCategory;

    return matchSearch && matchCategory;
});


    // ‚úÖ Sort by category then name
    filtered.sort((a, b) => {
        const catA = (a.category || 'Other').toLowerCase();
        const catB = (b.category || 'Other').toLowerCase();

        if (catA !== catB) return catA.localeCompare(catB);
        return a.name.localeCompare(b.name);
    });

    const tbody = document.getElementById('inventoryBody');
    let html = '';
    let lastCategory = null;

    filtered.forEach(item => {
        const margin = item.price - item.cost;
        const marginPercent = ((margin / item.cost) * 100).toFixed(1);

        // ‚úÖ Category header row
        if (item.category !== lastCategory) {
            lastCategory = item.category;
            html += `
                <tr class="category-row">
                    <td colspan="7" style="background:#f5f7fa;font-weight:bold;color:#0f3460;">
                        üìÅ ${item.category || 'Other'}
                    </td>
                </tr>
            `;
        }

        html += `
            <tr>
                <td>
                    <img src="${item.photo || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect fill=%22%23ddd%22 width=%2260%22 height=%2260%22/></svg>'}"
                         class="item-image"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect fill=%22%23ddd%22 width=%2260%22 height=%2260%22/></svg>'">
                </td>
                <td><span class="category-badge">${item.category}</span></td>
                <td><strong>${item.name}</strong></td>
                <td>‡ß≥${item.cost.toFixed(2)}</td>
                <td>‡ß≥${item.price.toFixed(2)}</td>
                <td class="${margin >= 0 ? 'profit-positive' : 'profit-negative'}">
                    ‡ß≥${margin.toFixed(2)} (${marginPercent}%)
                </td>
                <td>
                    <button class="btn btn-danger action-btn" onclick="deleteItem(${item.id})">Delete</button>
                    <button class="btn btn-info action-btn" onclick="editItem(${item.id})">Edit</button>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
}

        
        function deleteItem(id) {
            if (confirm('Delete this item?')) {
                inventory = inventory.filter(i => i.id !== id);
                populateCategoryFilter();
                renderInventory();
                saveToGoogleSheets();
            }
        }
        
        // ORDER FUNCTIONS
function updateProductDropdown() {
    const select = document.getElementById('orderProduct');
    if (!select) return;

    select.innerHTML = '<option value="">Select product</option>';

    if (!Array.isArray(inventory) || inventory.length === 0) return;

    // Group by category
    const categories = {};
    inventory.forEach(item => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
    });

    // Render grouped options
    Object.keys(categories).sort().forEach(category => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category;

        categories[category]
            .sort((a, b) => a.name.localeCompare(b.name))
            .forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;   // IMPORTANT
                option.textContent = `${item.name} - ‡ß≥${item.price}`;
                optgroup.appendChild(option);
            });

        select.appendChild(optgroup);
    });
}

        
        function updateCustomerDropdown() {
            const select = document.getElementById('orderCustomer');
            select.innerHTML = '<option value="">Select or add new customer</option>';
            customers.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name} - ${c.phone}</option>`;
            });
        }
        
        function loadCustomerData() {
            const customerId = document.getElementById('orderCustomer').value;
            if (!customerId) return;
            
            const customer = customers.find(c => c.id == customerId);
            if (customer) {
                document.getElementById('orderName').value = customer.name;
                document.getElementById('orderPhone').value = customer.phone;
                document.getElementById('orderEmail').value = customer.email || '';
                document.getElementById('orderAddress').value = customer.address || '';
                document.getElementById('orderNotes').value = customer.notes || '';
            }
        }
        
        function addProductToOrder() {
            const productId = document.getElementById('orderProduct').value;
            const quantity = parseInt(document.getElementById('orderQuantity').value) || 1;
            
            if (!productId) {
                alert('Select a product!');
                return;
            }
            
            const product = inventory.find(p => p.id == productId);
            currentOrderProducts.push({
                id: product.id,
                name: product.name,
                cost: product.cost,
                price: product.price,
                quantity
            });
            
            renderOrderProducts();
            calcOrderTotals();
        }
        
        function renderOrderProducts() {
            const div = document.getElementById('orderProductsList');
            div.innerHTML = currentOrderProducts.map((p, i) => `
                <div class="product-list-item">
                    <div>${p.name} √ó ${p.quantity}</div>
                    <div>
                        <strong>‡ß≥${(p.price * p.quantity).toFixed(2)}</strong>
                        <button class="btn btn-danger action-btn" onclick="removeOrderProduct(${i})">‚úñ</button>
                    </div>
                </div>
            `).join('');
        }
        
        function removeOrderProduct(index) {
            currentOrderProducts.splice(index, 1);
            renderOrderProducts();
            calcOrderTotals();
        }
        
        function calcOrderTotals() {
            const cost = currentOrderProducts.reduce((sum, p) => sum + (p.cost * p.quantity), 0);
            document.getElementById('orderCost').value = cost.toFixed(2);
            calcOrderProfit();
        }
        
        function calcOrderProfit() {
            const cost = parseFloat(document.getElementById('orderCost').value) || 0;
            const gross = parseFloat(document.getElementById('orderGross').value) || 0;
            document.getElementById('orderProfit').value = (gross - cost).toFixed(2);
        }
        
        function saveOrder() {
            const name = document.getElementById('orderName').value.trim();
            const phone = document.getElementById('orderPhone').value.trim();
            const email = document.getElementById('orderEmail').value.trim();
            const address = document.getElementById('orderAddress').value.trim();
            const notes = document.getElementById('orderNotes').value.trim();
            const gross = parseFloat(document.getElementById('orderGross').value);
            const cost = parseFloat(document.getElementById('orderCost').value);
            const profit = parseFloat(document.getElementById('orderProfit').value);
            const status = document.getElementById('orderStatus').value;
            
            if (!name || !phone || !address || currentOrderProducts.length === 0 || !gross) {
                alert('Fill required fields and add products!');
                return;
            }
            
            if (editingOrderId) {
                // Update existing order
                const order = orders.find(o => o.id === editingOrderId);
                if (order) {
                    order.customerName = name;
                    order.phone = phone;
                    order.email = email;
                    order.address = address;
                    order.notes = notes;
                    order.products = [...currentOrderProducts];
                    order.cost = cost;
                    order.gross = gross;
                    order.profit = profit;
                    order.status = status;
                }
                editingOrderId = null;
                document.querySelector('#orders .btn-primary').textContent = '‚úÖ Create Order';
                document.getElementById('cancelOrderBtn').style.display = 'none';
            } else {
                // Create new order
                const tracking = 'CC-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                
                // Save/update customer
                let customer = customers.find(c => c.phone === phone);
                if (customer) {
                    customer.orderCount++;
                    customer.totalSpent += gross;
                    customer.notes = notes;
                } else {
                    customer = {
                        id: Date.now(),
                        name,
                        phone,
                        email,
                        address,
                        notes,
                        orderCount: 1,
                        totalSpent: gross
                    };
                    customers.push(customer);
                }
                
                orders.push({
                    id: Date.now(),
                    tracking,
                    customerId: customer.id,
                    customerName: name,
                    phone,
                    email,
                    address,
                    notes,
                    products: [...currentOrderProducts],
                    cost,
                    gross,
                    profit,
                    status,
                    date: new Date().toLocaleDateString()
                });
                
                alert(`Order created! Tracking: ${tracking}`);
            }
            
            renderOrders();
            renderCustomers();
            saveToGoogleSheets();
            
            currentOrderProducts = [];
            document.getElementById('orderName').value = '';
            document.getElementById('orderPhone').value = '';
            document.getElementById('orderEmail').value = '';
            document.getElementById('orderAddress').value = '';
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderGross').value = '';
            document.getElementById('orderCost').value = '';
            document.getElementById('orderProfit').value = '';
            document.getElementById('orderCustomer').value = '';
            renderOrderProducts();
        }
        
        function editOrder(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            editingOrderId = id;
            document.getElementById('orderName').value = order.customerName;
            document.getElementById('orderPhone').value = order.phone;
            document.getElementById('orderEmail').value = order.email || '';
            document.getElementById('orderAddress').value = order.address;
            document.getElementById('orderNotes').value = order.notes || '';
            document.getElementById('orderStatus').value = order.status;
            document.getElementById('orderGross').value = order.gross;
            
            currentOrderProducts = order.products ? [...order.products] : [];
            renderOrderProducts();
            calcOrderTotals();
            
            document.querySelector('#orders .btn-primary').textContent = 'üíæ Update Order';
            document.getElementById('cancelOrderBtn').style.display = 'inline-block';
            
            showSection('orders');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function cancelEditOrder() {
            editingOrderId = null;
            currentOrderProducts = [];
            document.getElementById('orderName').value = '';
            document.getElementById('orderPhone').value = '';
            document.getElementById('orderEmail').value = '';
            document.getElementById('orderAddress').value = '';
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderGross').value = '';
            document.getElementById('orderCost').value = '';
            document.getElementById('orderProfit').value = '';
            document.getElementById('orderCustomer').value = '';
            renderOrderProducts();
            document.querySelector('#orders .btn-primary').textContent = '‚úÖ Create Order';
            document.getElementById('cancelOrderBtn').style.display = 'none';
        }
        
        function renderOrders() {
            const search = document.getElementById('searchOrders')?.value.toLowerCase() || '';
            const filtered = orders.filter(o => 
                o.tracking.toLowerCase().includes(search) || 
                o.customerName.toLowerCase().includes(search)
            );
            
            const tbody = document.getElementById('ordersBody');
            tbody.innerHTML = filtered.map(order => `
                <tr>
                    <td><strong>${order.tracking}</strong></td>
                    <td>${order.customerName}<br><small>${order.phone}</small></td>
<td><small>${
    (Array.isArray(order.products) ? order.products : [order.products])
        .flat()
        .map(p => `${p.name} (${p.quantity})`)
        .join(', ')
}</small></td>

                    <td>‡ß≥${order.gross.toFixed(2)}</td>
                    <td class="${order.profit >= 0 ? 'profit-positive' : 'profit-negative'}">‡ß≥${order.profit.toFixed(2)}</td>
                    <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                    <td>${order.date}</td>
                    <td>
                        <button class="btn btn-success action-btn" onclick="viewInvoice('${order.tracking}')">Invoice</button>
                        <button class="btn btn-info action-btn" onclick="editOrder(${order.id})">Edit</button>
                        <button class="btn btn-danger action-btn" onclick="deleteOrder(${order.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function deleteOrder(id) {
            if (confirm('Delete this order?')) {
                orders = orders.filter(o => o.id !== id);
                renderOrders();
                saveToGoogleSheets();
            }
        }
        
        // CUSTOMER FUNCTIONS
        function renderCustomers() {
            const search = document.getElementById('searchCustomers')?.value.toLowerCase() || '';
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(search) || 
                c.phone.includes(search)
            );
            
            const tbody = document.getElementById('customersBody');
            tbody.innerHTML = filtered.map(customer => `
                <tr>
                    <td><strong>${customer.name}</strong></td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${customer.orderCount || 0}</td>
                    <td>‡ß≥${(customer.totalSpent || 0).toFixed(2)}</td>
                    <td><small>${customer.notes || '-'}</small></td>
                    <td>
                        <button class="btn btn-info action-btn" onclick="viewCustomerOrders(${customer.id})">View Orders</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function viewCustomerOrders(customerId) {
            const customer = customers.find(c => c.id === customerId);
            const customerOrders = orders.filter(o => o.customerId === customerId);
            
            alert(`${customer.name}'s Orders:\n\n` + 
                customerOrders.map(o => `${o.tracking} - ${o.date} - ‡ß≥${o.gross}`).join('\n'));
        }
        
        // INVOICE FUNCTIONS
        function generateInvoice() {
            const tracking = document.getElementById('invoiceTracking').value.trim();
            if (!tracking) {
                alert('Enter tracking number!');
                return;
            }
            viewInvoice(tracking);
        }
        
        function viewInvoice(tracking) {
            const order = orders.find(o => o.tracking === tracking);
            if (!order) {
                alert('Order not found!');
                return;
            }
            
            const invoiceHTML = `
                <div class="invoice">
                    <div class="invoice-header">
                        <h1 style="color: #e94560;">üåô Crescent Charms BD</h1>
                        <p>Invoice</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h3>Customer Details:</h3>
                            <p><strong>Name:</strong> ${order.customerName}</p>
                            <p><strong>Phone:</strong> ${order.phone}</p>
                            <p><strong>Email:</strong> ${order.email || 'N/A'}</p>
                            <p><strong>Address:</strong> ${order.address}</p>
                        </div>
                        <div>
                            <h3>Order Details:</h3>
                            <p><strong>Tracking #:</strong> ${order.tracking}</p>
                            <p><strong>Date:</strong> ${order.date}</p>
                            <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span></p>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border: 1px solid #ddd;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 10px; text-align: left;">Product</th>
                                <th style="padding: 10px; text-align: right;">Qty</th>
                                <th style="padding: 10px; text-align: right;">Price</th>
                                <th style="padding: 10px; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.products.map(p => `
                                <tr>
                                    <td style="padding: 10px;">${p.name}</td>
                                    <td style="padding: 10px; text-align: right;">${p.quantity}</td>
                                    <td style="padding: 10px; text-align: right;">‡ß≥${p.price.toFixed(2)}</td>
                                    <td style="padding: 10px; text-align: right;">‡ß≥${(p.price * p.quantity).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <h2 style="color: #e94560;">Total: ‡ß≥${order.gross.toFixed(2)}</h2>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: center; border-top: 2px solid #eee; padding-top: 20px;">
                        <p>Thank you for your purchase!</p>
                        <p style="color: #666;">For queries: contact@crescentcharmsbd.com</p>
                    </div>
                </div>
            `;
            
            document.getElementById('invoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoiceModal').style.display = 'block';
        }
        
        function closeInvoice() {
            document.getElementById('invoiceModal').style.display = 'none';
        }
        
        // DATA PERSISTENCE
        async function saveToGoogleSheets() {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === '') {
                console.log('‚ö†Ô∏è Google Sheets not configured');
                return;
            }
            
            try {
                // Save Inventory
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheet: 'Inventory',
                        items: inventory
                    })
                });
                
                // Save Orders
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheet: 'Orders',
                        orders: orders
                    })
                });
                
                // Save Customers
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheet: 'Customers',
                        customers: customers
                    })
                });
                
                console.log('‚úÖ Data saved to Google Sheets!');
            } catch (error) {
                console.error('‚ùå Error saving to Google Sheets:', error);
            }
        }
        
        async function loadFromGoogleSheets() {
            try {
                // Load Inventory
                const invResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Inventory?key=${API_KEY}`
                );
                const invData = await invResponse.json();
                if (invData.values && invData.values.length > 1) {
                    inventory = invData.values.slice(1).map(row => ({
                        id: parseInt(row[0]) || Date.now(),
                        name: row[1] || '',
                        category: row[2] || '',
                        cost: parseFloat(row[3]) || 0,
                        price: parseFloat(row[4]) || 0,
                        link: row[5] || '',
                        photo: row[6] || ''
                    }));
                }
                
                // Load Orders
                const ordResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Orders?key=${API_KEY}`
                );
                const ordData = await ordResponse.json();
                if (ordData.values && ordData.values.length > 1) {
                    orders = ordData.values.slice(1).map(row => ({
                        id: parseInt(row[0]) || Date.now(),
                        tracking: row[1] || '',
                        customerId: parseInt(row[2]) || 0,
                        customerName: row[3] || '',
                        phone: row[4] || '',
                        email: row[5] || '',
                        address: row[6] || '',
                        notes: row[7] || '',
                        products: row[8] ? JSON.parse(row[8]) : [],
                        cost: parseFloat(row[9]) || 0,
                        gross: parseFloat(row[10]) || 0,
                        profit: parseFloat(row[11]) || 0,
                        status: row[12] || 'pending',
                        date: row[13] || ''
                    }));
                }
                
                // Load Customers
                const custResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Customers?key=${API_KEY}`
                );
                const custData = await custResponse.json();
                if (custData.values && custData.values.length > 1) {
                    customers = custData.values.slice(1).map(row => ({
                        id: parseInt(row[0]) || Date.now(),
                        name: row[1] || '',
                        phone: row[2] || '',
                        email: row[3] || '',
                        address: row[4] || '',
                        notes: row[5] || '',
                        orderCount: parseInt(row[6]) || 0,
                        totalSpent: parseFloat(row[7]) || 0
                    }));
                }
                
                console.log('‚úÖ Data loaded from Google Sheets!');
            } catch (error) {
                console.error('‚ùå Error loading from Google Sheets:', error);
            }
        }
        
        // Initialize - Load data on page load
        window.addEventListener('load', loadFromGoogleSheets);
        
        // Initialize
        window.onclick = function(event) {
            if (event.target == document.getElementById('invoiceModal')) {
                closeInvoice();
            }
        }

        function populateCategoryFilter() {
    const select = document.getElementById('categoryFilter');
    if (!select) return;

    const categories = [...new Set(inventory.map(i => i.category || 'Other'))].sort();

    select.innerHTML = '<option value="">All Categories</option>';

    categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
    });
}

    </script>
</body>
</html>
